name: Update M√©t√©o Daily

on:
  schedule:
    # Tous les jours √† 17h UTC ‚Üí 18h (hiver) ou 19h (√©t√©) en France
    - cron: '0 17 * * *'
  
  # Bouton "Run workflow" dans l'interface GitHub
  workflow_dispatch:

jobs:
  update-meteo:
    runs-on: ubuntu-latest
    
    steps:
      # 1. R√©cup√©ration du repo
      - name: üì• Checkout repository
        uses: actions/checkout@v4

      # 2. Installation de Python
      - name: üêç Setup Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      # 3. Installation des d√©pendances n√©cessaires
      - name: üì¶ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests pandas  # Ajoute ici d'autres packages si ton script en utilise

      # 4. Ex√©cution du script qui r√©cup√®re et met √† jour les donn√©es m√©t√©o
      - name: üå§Ô∏è Fetch weather data
        run: |
          python scripts/fetch_meteo_auto.py

      # 5. Commit et push uniquement s'il y a des modifications
      - name: üíæ Commit and push changes
        run: |
          # Identit√© officielle du bot GitHub Actions (affich√©e clairement dans l'historique)
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          
          # Ajoute les fichiers modifi√©s par ton script (ajuste si tu en as d'autres)
          git add data/meteo_cache.csv
          # Exemples si besoin : git add data/autre_fichier.json data/*.csv
          
          # V√©rifie s'il y a vraiment des changements
          if git diff --staged --quiet; then
            echo "Aucun changement d√©tect√© dans les donn√©es m√©t√©o."
          else
            git commit -m "chore: mise √† jour donn√©es m√©t√©o - $(date +'%Y-%m-%d %H:%M UTC')"
            git push
            echo "Donn√©es m√©t√©o mises √† jour et pouss√©es avec succ√®s !"
          fi

      # 6. Message clair en cas d'erreur
      - name: ‚ö†Ô∏è Notify on failure
        if: failure()
        run: |
          echo "‚ùå La mise √† jour des donn√©es m√©t√©o a √©chou√© le $(date +'%Y-%m-%d %H:%M UTC')"
