name: Update BERA & MÃ©tÃ©o Daily

on:
  schedule:
    # Tous les jours Ã  17h UTC (18h Paris hiver, 19h Paris Ã©tÃ©)
    # Les bulletins BERA sont publiÃ©s vers 16h
    - cron: '0 17 * * *'
  
  # Permet le dÃ©clenchement manuel depuis l'interface GitHub
  workflow_dispatch:

jobs:
  update-data:
    runs-on: ubuntu-latest
    
    steps:
      # 1. Checkout du repo
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4
      
      # 2. Setup Python
      - name: ðŸ Setup Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      # 3. Installation des dÃ©pendances
      - name: ðŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests pandas python-dotenv
      
      # 4. CrÃ©ation du fichier .env avec les secrets GitHub
      - name: ðŸ” Configure environment
        run: |
          echo "METEO_FRANCE_CLIENT_ID=${{ secrets.METEO_FRANCE_CLIENT_ID }}" >> .env
          echo "METEO_FRANCE_CLIENT_SECRET=${{ secrets.METEO_FRANCE_CLIENT_SECRET }}" >> .env
      
      # 5. RÃ©cupÃ©ration BERA
      - name: ðŸ”ï¸ Fetch BERA bulletins
        run: |
          python scripts/fetch_bera_auto.py
        continue-on-error: true  # Continue mÃªme si BERA Ã©choue
      
      # 6. RÃ©cupÃ©ration MÃ©tÃ©o
      - name: ðŸŒ¤ï¸ Fetch weather data
        run: |
          python scripts/fetch_meteo_auto.py
      
      # 7. Commit et push des changements
      - name: ðŸ’¾ Commit and push changes
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          git add data/bera_latest.json data/bera_latest.csv data/meteo_cache.csv
          
          # VÃ©rifie s'il y a des changements
          if git diff --staged --quiet; then
            echo "Aucun changement dÃ©tectÃ©"
          else
            git commit -m "chore: update BERA & mÃ©tÃ©o data - $(date +'%Y-%m-%d %H:%M')"
            git push
          fi
      
      # 8. Notification en cas d'Ã©chec (optionnel)
      - name: ðŸ“§ Notify on failure
        if: failure()
        run: |
          echo "âŒ Update failed on $(date)"
          # Tu peux ajouter une notification Slack/Discord/Email ici

# Workflow pour tester manuellement les scripts en dÃ©veloppement
  test-scripts:
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'
    
    steps:
      - uses: actions/checkout@v4
      
      - name: ðŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: ðŸ“¦ Install dependencies
        run: |
          pip install requests pandas python-dotenv
      
      - name: ðŸ” Configure environment
        run: |
          echo "METEO_FRANCE_CLIENT_ID=${{ secrets.METEO_FRANCE_CLIENT_ID }}" >> .env
          echo "METEO_FRANCE_CLIENT_SECRET=${{ secrets.METEO_FRANCE_CLIENT_SECRET }}" >> .env
      
      - name: ðŸ§ª Test BERA script
        run: |
          python scripts/fetch_bera_auto.py
      
      - name: ðŸ§ª Test MÃ©tÃ©o script
        run: |
          python scripts/fetch_meteo_auto.py
      
      - name: ðŸ“Š Show data preview
        run: |
          echo "=== BERA Preview ==="
          head -n 5 data/bera_latest.csv || echo "No BERA data"
          echo ""
          echo "=== MÃ©tÃ©o Preview ==="
          head -n 5 data/meteo_cache.csv || echo "No mÃ©tÃ©o data"